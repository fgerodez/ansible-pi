- name: Install system packages
  become: true
  apt:
    pkg:
      - wireguard
      - jq
      
- name: Copy wireguard script
  become: true
  register: wireguardscript
  ansible.builtin.copy:
    src: mahoneko-wg.sh
    dest: /usr/local/bin/
    mode: 0700

- name: Copy wireguard credentials
  become: true
  register: wireguardconfig
  ansible.builtin.copy:
    src: login.conf
    dest: /etc/wireguard/
    mode: 0600

- name: Copy systemd service
  become: true
  register: wireguardservice
  ansible.builtin.copy:
    src: wg-mahoneko.service
    dest: /etc/systemd/system/
    mode: 0644
    
- name: Enable wireguard service
  become: true
  ansible.builtin.systemd:
    name: wg-mahoneko.service
    daemon_reload: "{{ wireguardservice.changed }}"
    enabled: true
    state: "{{ 'restarted' if wireguardconfig.changed or wireguardscript.changed else 'started' }}"

